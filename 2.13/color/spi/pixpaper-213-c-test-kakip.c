/*
 * Author: LC Wang <zaq14760@gmail.com>
 * Date: 2025-01-15
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/ioctl.h>
#include <linux/spi/spidev.h>
#include <gpiod.h>
#include <time.h>
#include <stdint.h>
#define EPD_SPI_DEVICE "/dev/spidev0.0"
#define EPD_GPIO_CHIP "gpiochip0"

#define EPD_DC_PIN 60
#define EPD_RST_PIN 87
#define EPD_BUSY_PIN 91

#define SOURCE_BITS 122
#define GATE_BITS 250

#define SPI_SPEED 5000000

int spi_fd;
struct gpiod_chip *chip;
struct gpiod_line *epd_dc_line, *epd_rst_line, *epd_busy_line;

uint32_t img_hex[122][16] = {
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55554015,0x55555500,0x55455555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x556aaa55,0x055415aa,0xaa455555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x556aaaaa,0x55556aaa,0xaa455555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x555aaaaa,0xa95aaaaa,0xa9555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x5556aaaa,0xaaaaaaaa,0xa5555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x5f55aaaa,0xaaaaaaaa,0x957d5455,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x5555155f,0xffd56aaa,0xa51aaaaa,0x55fff551,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x555555ff,0xfff55aaa,0xa416aaa9,0x57ffffd5,0x55455555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x555555ff,0xfff55aaa,0xa416aaa5,0x57fffffd,0x54055555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x5555557f,0xffd55aaa,0xa416aaa9,0x57ffffff,0x54055555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x555d555f,0xff55aaaa,0xa95aaaaa,0x55fffffd,0x50055555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55fd5557,0xfd56aaaa,0xaaaaaaaa,0x957fffd5,0x55155555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x5ffd5f55,0xfd5aaaaa,0xaaaaaaaa,0xa55ff555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x7ffd5fd5,0x556aaaaa,0xa556aaaa,0xa9555557,0xfd5d5555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0xfffd5ff5,0x556aaaa9,0x54155aaa,0xaa55557f,0xfd5f5555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555557,0xfffd5ffd,0x516a9554,0x55550556,0xaa415fff,0xfd5fd555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x5555555f,0xfffd5fff,0x54555555,0x55d55550,0x55557fff,0xfd5ff555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x5555557f,0xfffd5fff,0x55555555,0xffff5555,0x55557fff,0xfd5ffd55,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x5554017f,0xfffd5fff,0xd5555557,0xffffd555,0x5555ffff,0xfd5fff55,0x55555000,}, 
{0x55555555,0x55555555,0x40005555,0x55555550,0x00155555,0x55555555,0x55555000,0x01555554,0x00015555,0x5554017f,0xfffd5fff,0xfd55555f,0xffffd555,0x7fffffff,0xfd5fff51,0x55555000,}, 
{0x55555555,0x55555555,0x00005555,0x55555550,0x00155555,0x55555555,0x55555000,0x00555554,0x00015555,0x5554017f,0xfffd5fff,0xff55557f,0xffffd557,0xffffffff,0xfd5fffd5,0x55555000,}, 
{0x55555555,0x55555555,0x00005555,0x55555550,0x00055555,0x55555555,0x55555500,0x00155554,0x00015555,0x5554157f,0xfffd5fff,0xffd5517f,0xffff5555,0xffffffff,0xfd5fffd5,0x55555000,}, 
{0x55555555,0x55555555,0x00001555,0x55555550,0x00055555,0x55555555,0x55555500,0x00155555,0x00015555,0x5555555f,0xfffd5fff,0xffd5015f,0xfffd5755,0x7fffffff,0xfd5ffff5,0x55555000,}, 
{0x55555555,0x55555555,0x00001555,0x55555550,0x00055555,0x55555555,0x55555540,0x00055555,0x00015555,0x55555557,0xfffd5fff,0xffd5015f,0xfff55fd5,0x5fffffff,0xfd5ffff5,0x55555000,}, 
{0x55555555,0x55555555,0x40005555,0x55555550,0x00055555,0x55555555,0x55555550,0x00015555,0x00005555,0x55557f55,0xfffd5fff,0xffd5015f,0xffd57ff5,0x57ffffff,0xfd5ffffd,0x55555000,}, 
{0x55555555,0x55555555,0x54005555,0x55555550,0x00055555,0x55555555,0x55555555,0x00005555,0x00005555,0x5555ffd5,0x7ffd5fff,0xffd5457f,0xff55fffd,0x557fffff,0xfd5ffffd,0x45555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555554,0x00015555,0x55555555,0x55555555,0x00001555,0x00005555,0x5555fff5,0x5ffd5fff,0xfff5557f,0xfd57ffff,0x5555ffff,0xfd5fffff,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555554,0x00015555,0x55555555,0x55555555,0x40000555,0x40005555,0x5545fffd,0x57fd5fff,0xffff55ff,0xf55fffff,0xd5557fff,0xfd5fffff,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555554,0x00015555,0x55555555,0x55555555,0x50000155,0x40001555,0x5557ffff,0x55fd5fff,0xffffd57f,0xd55fffff,0xd5055555,0x555fffff,0x51555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555554,0x00015555,0x55555555,0x55555555,0x54000055,0x40001555,0x5557ffff,0xd57d5fff,0xfffff57f,0x557fffff,0xd5015555,0x555fffff,0xd1555000,}, 
{0x55540000,0x55000155,0x50000554,0x00001554,0x00015550,0x00154000,0x05555555,0x55000015,0x40001555,0x5557ffff,0xf5555fff,0xfffff57d,0x55ffffff,0xd5005555,0x555fffff,0xd1555000,}, 
{0x55500000,0x15000155,0x50000555,0x00000554,0x00015550,0x00150000,0x00555555,0x55400015,0x40001555,0x5557ffff,0xfd555fff,0xfffff555,0x57ffffff,0xd5015fff,0xd557ffff,0xd5555000,}, 
{0x55400000,0x05000055,0x50000555,0x50000554,0x00015550,0x00040000,0x00555555,0x55500005,0x40001555,0x5517ffff,0xff555fff,0xfffffd55,0x5fffffff,0xf5557fff,0xd557ffff,0xd5555000,}, 
{0x55000000,0x00000055,0x50000555,0x54000154,0x00015554,0x00000000,0x00055555,0x55500000,0x00001555,0x551fffff,0xffd55555,0x55555555,0x7fffffff,0xf555ffff,0xd555ffff,0xd5555000,}, 
{0x54000000,0x00000055,0x50000155,0x55000055,0x00005554,0x00000000,0x00015555,0x55500000,0x00000555,0x551fffff,0xffd55555,0x55555545,0xffffffff,0xd557ffff,0x55d57fff,0xd5555000,}, 
{0x54000015,0x00000055,0x50000155,0x55000015,0x00005554,0x00000140,0x00015555,0x55500000,0x00000555,0x551fffff,0xf5555555,0x55555555,0x7fffffff,0xd57fffff,0x57f57fff,0xd5555000,}, 
{0x54000055,0x50000055,0x54000155,0x55400005,0x00005554,0x00001554,0x00005555,0x55400000,0x00000555,0x555ffffd,0x55557fff,0xffff5555,0x5fffffff,0x55fffffd,0x57f55fff,0xd5555000,}, 
{0x54000155,0x54000015,0x54000155,0x55500000,0x00005554,0x00001555,0x00001555,0x55400000,0x00000555,0x555ffd55,0x557fffff,0xffffd575,0x57ffffff,0x57fffffd,0x5ffd5fff,0xd5555000,}, 
{0x54000155,0x55000015,0x54000155,0x55540000,0x00005554,0x00005555,0x40001555,0x55000000,0x00000555,0x55155555,0x57ffffff,0xffff55fd,0x557ffffd,0x57fffff5,0x5ffd57ff,0xd5555000,}, 
{0x54000155,0x55000015,0x54000155,0x55550000,0x00005555,0x00005555,0x50001555,0x55000054,0x00000555,0x55155555,0xffffffff,0xfffd57ff,0x555ffff5,0x5ffffff5,0x7fff57ff,0xd5555000,}, 
{0x54000155,0x55000015,0x54000155,0x55550000,0x00001555,0x00005555,0x50000555,0x55000054,0x00000555,0x551555ff,0xffffffff,0xfff55fff,0xf557ffd5,0x7fffffd5,0x7fff55ff,0xd5555000,}, 
{0x54000155,0x55000015,0x54000155,0x55540000,0x00001555,0x00005555,0x50000555,0x54000055,0x00000555,0x5515555f,0xffffffff,0xffd57fff,0xfd55ffd5,0x7fffffd5,0xffffd5ff,0xd5555000,}, 
{0x54000155,0x55000015,0x55000055,0x55540000,0x00001555,0x00005555,0x50000555,0x54000055,0x40000155,0x55155555,0x5fffffff,0xff557fff,0xff557f55,0xffffff55,0xffffd57f,0xd5555000,}, 
{0x54000155,0x55000015,0x55000055,0x55540000,0x00001555,0x00001555,0x50000555,0x54000155,0x50000155,0x55555555,0x5557ffff,0xfd55ffff,0xffd55557,0xffffff57,0xfffff57f,0xd1555000,}, 
{0x55000055,0x55000015,0x55000055,0x55500000,0x00001555,0x00001555,0x50000555,0x50000155,0x54000155,0x5557ff55,0x555557ff,0xf557ffff,0xfffd5557,0xfffffd57,0xfffffd5f,0xd1555000,}, 
{0x55000055,0x55000015,0x55000055,0x55400005,0x40000555,0x00000555,0x40000555,0x00000555,0x54000155,0x5557ffff,0xd555555f,0xd55fffff,0xffff5555,0x55555557,0xfffffd57,0x51555000,}, 
{0x55400015,0x50000015,0x55000055,0x55400015,0x50000555,0x00000155,0x00000540,0x00000555,0x54000155,0x5555ffff,0xffd55555,0x557fffff,0xffffd555,0x55555555,0x57ffff57,0x55555000,}, 
{0x55400000,0x00000015,0x55400055,0x40000015,0x50000555,0x00000000,0x00001550,0x00001555,0x54000155,0x5545ffff,0xffffd555,0x557fffff,0xffff5555,0x55555555,0x5557ff55,0x55555000,}, 
{0x55500000,0x00000005,0x55400015,0x40000015,0x50000555,0x00000000,0x00001550,0x00001555,0x55000055,0x5555ffff,0xffffff55,0x155fffff,0xfffd55ff,0xffffd555,0x55555755,0x05555000,}, 
{0x55540000,0x00000005,0x55400015,0x50000015,0x50000555,0x40000000,0x00005550,0x00005555,0x55000055,0x55557fff,0xffffff55,0x5555ffff,0xfffd57ff,0xffffd55f,0xf5555554,0x01555000,}, 
{0x55550000,0x00000005,0x55400015,0x50000055,0x50000155,0x40001000,0x00015554,0x00005555,0x55000055,0x55557fff,0xfffffd55,0x55557fff,0xfff55fff,0xffff555f,0xfffd5550,0x01555000,}, 
{0x55554000,0x00540005,0x55400015,0x50000155,0x54000155,0x40001500,0x00055554,0x00015555,0x55000055,0x55555fff,0xffffd557,0x57d557ff,0xffd57fff,0xfffd555f,0xfffffd50,0x01555000,}, 
{0x55555000,0x01540005,0x55400015,0x50000555,0x54000155,0x40001540,0x00155554,0x00155555,0x55000055,0x55555fff,0xfffd555f,0x57f5557f,0xfd55ffff,0xfffd555f,0xffffff55,0x05555000,}, 
{0x55555555,0x55540001,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x555557ff,0xfff555ff,0x57ff5555,0x5557ffff,0xfff55d5f,0xffffffd5,0x55555000,}, 
{0x55555555,0x55540001,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x555557ff,0xffd55fff,0x57fff555,0x5557ffff,0xfff57d5f,0xffffffd5,0x55555000,}, 
{0x55555555,0x55540001,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x555555ff,0xfd557fff,0x57ffff55,0x545fffff,0xffd57d5f,0xffffff55,0x55555000,}, 
{0x55555555,0x55550001,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x5555557f,0xd557ffff,0x57ffffd5,0x0057ffff,0xffd5fd5f,0xfffffd55,0x55555000,}, 
{0x55555555,0x55550001,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x555fffff,0x57fffff5,0x4057ffff,0xff55fd5f,0xfffff555,0x55555000,}, 
{0x55555555,0x55550001,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55ffffff,0x57fffff5,0x005fffff,0xff57fd5f,0xfffff555,0x55555000,}, 
{0x55555555,0x55550000,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555515,0x57ffffff,0x57ffffd5,0x5557ffff,0xfd57fd5f,0xffffd555,0x55555000,}, 
{0x55555555,0x55550000,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555501,0x5fffffff,0x57ffff55,0x5555ffff,0xf55ffd5f,0xffff5555,0x55555000,}, 
{0x55555555,0x55550000,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555401,0x5fffffff,0x57fffd55,0xd7557fff,0xf55ffd5f,0xfff55555,0x55555000,}, 
{0x55555555,0x55550000,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555500,0x57ffffff,0x57fff557,0xffd57fff,0xd57ffd5f,0xffd55555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x557fffff,0x57ff557f,0xfff55fff,0xd5fffd5f,0xfd555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x555fffff,0x57fd55ff,0xfffd57ff,0x55fffd5f,0xf5555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x5555ffff,0x57f557ff,0xffff55ff,0x57fffd5f,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x555557ff,0x57d55fff,0xffff557d,0x57fffd55,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x5555555f,0x55557fff,0xffffd555,0x5ffff555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x5555ffff,0xfffff555,0x5ffd5555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x5557ffff,0xfffff555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555501,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555500,0x01555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555500,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,}, 
{0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555000,},
};

void sleep_ms(unsigned int milliseconds) {
    struct timespec ts;
    ts.tv_sec = milliseconds / 1000;
    ts.tv_nsec = (milliseconds % 1000) * 1000000;
    nanosleep(&ts, NULL);
}


void sleep_us(unsigned int microseconds) {
    struct timespec ts;
    ts.tv_sec = microseconds / 1000000;
    ts.tv_nsec = (microseconds % 1000000) * 1000;
    nanosleep(&ts, NULL);
}


void spi_write(uint8_t *data, int len) {
    struct spi_ioc_transfer tr = {
        .tx_buf = (unsigned long)data,
        .len = len,
        .speed_hz = SPI_SPEED,
        .bits_per_word = 8,
    };
    ioctl(spi_fd, SPI_IOC_MESSAGE(1), &tr);
}

void epd_writeCommand(uint8_t command){
    gpiod_line_set_value(epd_dc_line, 0);
    sleep_us(1);
    spi_write(&command, 1);
}

void epd_writeData(uint8_t data){
    gpiod_line_set_value(epd_dc_line, 1);
    sleep_us(1);
    spi_write(&data, 1);

}

void epd_waitUntilIdle(){
    sleep_ms(2);
    while(true){
        if(gpiod_line_get_value(epd_busy_line) == 1){
            break;
        }
    }
}

void epd_waitUntilIdle_N(){
    sleep_ms(2);
    while(true){
        if(gpiod_line_get_value(epd_busy_line) == 0){
            break;
        }
        sleep_ms(10);
    }
}

void epd_HWreset(){
    sleep_ms(50);
    gpiod_line_set_value(epd_rst_line, 0);
    sleep_ms(50);
    gpiod_line_set_value(epd_rst_line, 1);
    sleep_ms(50);
}

void epd_driverOutputControl_dataF(uint8_t* data, uint16_t A, uint8_t B){
    *(data+0) = (uint8_t)A;
    *(data+1) = (uint8_t)(A>>8);
    *(data+2) = (uint8_t)(B);
}

uint8_t img_fetch_hex_32(int y, int x, uint32_t* img_src){
    int hsize = 250/16 + (250%16==0 ? 0 : 1);
    if(y >=122 || x>=250){
        return 0b11;
    }
    else{
        uint32_t target = *(img_src+hsize*y + (int)(x/16));
        return (target)>>((15 - x%16)*2) & 0b11;
    }
}

void epd_init(){

    spi_fd = open(EPD_SPI_DEVICE, O_RDWR);
    if (spi_fd < 0) {
        perror("Error opening SPI device");
        exit(1);
    }


    uint8_t mode = SPI_MODE_0;
    ioctl(spi_fd, SPI_IOC_WR_MODE, &mode);


    uint32_t speed = SPI_SPEED;
    ioctl(spi_fd, SPI_IOC_WR_MAX_SPEED_HZ, &speed);

    chip = gpiod_chip_open_by_name(EPD_GPIO_CHIP);
    if (!chip) {
        perror("Error opening GPIO chip");
        exit(1);
    }

    epd_dc_line = gpiod_chip_get_line(chip, EPD_DC_PIN);
    epd_rst_line = gpiod_chip_get_line(chip, EPD_RST_PIN);
    epd_busy_line = gpiod_chip_get_line(chip, EPD_BUSY_PIN);

    if (!epd_dc_line || !epd_rst_line || !epd_busy_line) {
        perror("Error getting GPIO lines");
        gpiod_chip_close(chip);
        exit(1);
    }

    gpiod_line_request_output(epd_dc_line, "epd_dc", 0);
    gpiod_line_request_output(epd_rst_line, "epd_rst", 0);
    gpiod_line_request_input(epd_busy_line, "epd_busy");

    printf("start\n");
    epd_HWreset();
    sleep_ms(1000);
    epd_waitUntilIdle();
    printf("reset successed\n");

    epd_writeCommand(0x4D);
    epd_writeData(0x78);
    epd_waitUntilIdle();

    epd_writeCommand(0x00); //PSR
    epd_writeData(0b00001111);
    epd_writeData(0b00001001);
    epd_waitUntilIdle();

    epd_writeCommand(0x01); //PWRR
    epd_writeData(0x07);
    epd_writeData(0x00);
    epd_writeData(0x22);
    epd_writeData(0x78);
    epd_writeData(0x0A);
    epd_writeData(0x22);
    epd_waitUntilIdle();

    epd_writeCommand(0x03); //POFS
    epd_writeData(0x10);
    epd_writeData(0x54);
    epd_writeData(0x44);
    epd_waitUntilIdle();

    epd_writeCommand(0x06); //BTST_P
    epd_writeData(0x0F);
    epd_writeData(0x0A);
    epd_writeData(0x2F);
    epd_writeData(0x25);
    epd_writeData(0x22);
    epd_writeData(0x2E);
    epd_writeData(0x21);
    epd_waitUntilIdle();

    epd_writeCommand(0x30); //CDI
    epd_writeData(0x02);
    epd_waitUntilIdle();

    epd_writeCommand(0x41);
    epd_writeData(0x00);
    epd_waitUntilIdle();

    epd_writeCommand(0x50);
    epd_writeData(0x37);
    epd_waitUntilIdle();

    epd_writeCommand(0x60);
    epd_writeData(0x02);
    epd_writeData(0x02);
     epd_waitUntilIdle();

    epd_writeCommand(0x61);
    epd_writeData(0x00);   // Source_BITS_H
    epd_writeData(0x80);   // Source_BITS_L
    epd_writeData(0x00);   // Gate_BITS_H
    epd_writeData(0xFA);
    epd_waitUntilIdle();

    epd_writeCommand(0x65);
    epd_writeData(0x00);
    epd_writeData(0x00);
    epd_writeData(0x00);
    epd_writeData(0x00);
    epd_waitUntilIdle();

    epd_writeCommand(0xE7);
    epd_writeData(0x1C);
    epd_waitUntilIdle();

    epd_writeCommand(0xE3);
    epd_writeData(0x22);
    epd_waitUntilIdle();

    epd_writeCommand(0xE0);
    epd_writeData(0x00);
    epd_waitUntilIdle();

    epd_writeCommand(0xB4);
    epd_writeData(0xD0);
    epd_waitUntilIdle();

    epd_writeCommand(0xB5);
    epd_writeData(0x03);
    epd_waitUntilIdle();

    epd_writeCommand(0xE9);
    epd_writeData(0x01);
    epd_waitUntilIdle();
}

void epd_write_img(uint32_t* img_src){
    epd_writeCommand(0x10);
    sleep_ms(10);

    for(uint i=0;i<250;i++)
    {
        for(uint j=0;j<32;j++){
            uint8_t ty = (img_fetch_hex_32(j*4+0,i, img_src)<<6) | (img_fetch_hex_32(j*4+1,i, img_src)<<4) | (img_fetch_hex_32(j*4+2,i, img_src)<<2) | (img_fetch_hex_32(j*4+3,i, img_src)<<0);
           epd_writeData(ty);
        }
    }

    epd_waitUntilIdle();

    printf("wait\n");
    printf("write image successed, starting update image\n");

    epd_writeCommand(0x04);
    sleep_ms(10);
    epd_writeData(0x00);
    epd_waitUntilIdle();

    epd_writeCommand(0x12);
    sleep_ms(10);
    epd_writeData(0x00);
    epd_waitUntilIdle();
    printf("update image successed\n");

    gpiod_line_set_value(epd_rst_line, 0);
    gpiod_line_set_value(epd_dc_line, 0);
}

int main(){
    while(true){
        epd_init();
        epd_write_img(&img_hex[0][0]);
        sleep_ms(30*1000);
    }


    close(spi_fd);
    gpiod_line_release(epd_dc_line);
    gpiod_line_release(epd_rst_line);
    gpiod_line_release(epd_busy_line);
    gpiod_chip_close(chip);

    return 0;
}
